name: Deploy to Plesk (settled)

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-prod
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Read current mtime (no-cache)
        id: start
        run: |
          MTIME_URL="https://www.formationeda-ia.com/admin/gitmtime.php?token=fb_2025_test_937abX&nocache=$(date +%s)"
          START=$(curl -LfsS "$MTIME_URL" || echo 0)
          echo "start=$START" >> "$GITHUB_OUTPUT"
          echo "Start mtime: $START"

      - name: Wait until mtime is STABLE (quiet 12s) or timeout
        env:
          START_MTIME: ${{ steps.start.outputs.start }}
        run: |
          MTIME_URL="https://www.formationeda-ia.com/admin/gitmtime.php?token=fb_2025_test_937abX&nocache=$(date +%s)"
          QUIET_REQUIRED=12   # secondes consécutives sans changement
          QUIET=0
          TOTAL=0
          TIMEOUT=240         # 4 min max

          echo "Waiting for /git-build to settle (quiet ${QUIET_REQUIRED}s)…"
          LAST=$(curl -LfsS "$MTIME_URL" || echo 0)
          while [ $TOTAL -lt $TIMEOUT ]; do
            sleep 2
            CUR=$(curl -LfsS "$MTIME_URL" || echo 0)
            if [ "$CUR" -ne "$LAST" ] && [ "$CUR" -ne 0 ]; then
              echo "mtime changed: $LAST -> $CUR (reset quiet)"
              LAST=$CUR
              QUIET=0
            else
              QUIET=$((QUIET+2))
            fi
            TOTAL=$((TOTAL+2))
            echo "[t=$TOTALs] mtime=$CUR, quiet=$QUIET/${QUIET_REQUIRED}"
            if [ $QUIET -ge $QUIET_REQUIRED ]; then
              echo "Settled."
              break
            fi
          done
          echo "Proceed to deploy (even if not settled)."

      - name: Trigger deploy (POST then GET fallback)
        shell: bash
        run: |
          set +e
          DEPLOY_POST_URL="https://www.formationeda-ia.com/admin/deploy.php"
          DEPLOY_GET_URL="https://www.formationeda-ia.com/admin/deploy.php?token=fb_2025_test_937abX&nocache=$(date +%s)"

          echo "POST -> $DEPLOY_POST_URL"
          HTTP=$(curl -sS -X POST \
            --connect-timeout 5 --max-time 25 --retry 3 --retry-delay 3 \
            -A "GitHubActions/Deploy" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "token=fb_2025_test_937abX" \
            -o /tmp/deploy_post_body.txt -w "%{http_code}" "$DEPLOY_POST_URL")
          echo "HTTP=$HTTP"
          sed -n '1,200p' /tmp/deploy_post_body.txt || true

          if [ "$HTTP" != "200" ]; then
            echo "Fallback GET -> $DEPLOY_GET_URL"
            HTTP2=$(curl -sS -L \
              --connect-timeout 5 --max-time 25 --retry 3 --retry-delay 3 \
              -A "GitHubActions/Deploy" \
              -o /tmp/deploy_get_body.txt -w "%{http_code}" "$DEPLOY_GET_URL")
            echo "HTTP2=$HTTP2"
            sed -n '1,200p' /tmp/deploy_get_body.txt || true
          fi

