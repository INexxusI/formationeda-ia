name: Deploy to Plesk (robust)
on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Read start mtime
        id: start
        run: |
          MTIME_URL="https://www.formationeda-ia.com/admin/gitmtime.php?token=fb_2025_test_937abX"
          START=$(curl -fsS "$MTIME_URL" || echo 0)
          echo "start=$START" >> "$GITHUB_OUTPUT"
          echo "Start mtime: $START"

      - name: Wait for Plesk update (mtime change or timeout)
        env:
          START_MTIME: ${{ steps.start.outputs.start }}
        run: |
          MTIME_URL="https://www.formationeda-ia.com/admin/gitmtime.php?token=fb_2025_test_937abX"
          echo "Waiting for mtime to change (or timeout)…"
          CHANGED=0
          for i in $(seq 1 120); do  # max ~4min
            CUR=$(curl -fsS "$MTIME_URL" || echo 0)
            echo "[$i] mtime=$CUR (start=$START_MTIME)"
            if [ "$CUR" -ne "$START_MTIME" ] && [ "$CUR" -ne 0 ]; then
              CHANGED=1
              echo "Detected change in /git-build."
              break
            fi
            sleep 2
          done
          # On déploie de toute façon, même si pas de changement détecté
          echo "Proceeding to deploy (changed=$CHANGED)."

      - name: Trigger deploy (mirror copy git-build -> prod)
        run: |
          curl -fsS "https://www.formationeda-ia.com/admin/deploy.php?token=fb_2025_test_937abX"
